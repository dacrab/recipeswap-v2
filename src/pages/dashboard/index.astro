---
import Layout from '../../layouts/Layout.astro';
import { recipes, bookmarks } from '../../db/schema';
import { eq, desc } from 'drizzle-orm';

const user = Astro.locals.user;
if (!user) return Astro.redirect('/login');

const db = Astro.locals.db;

const activeTab = Astro.url.searchParams.get('tab') || 'my-recipes';

let recipesToShow = [];

if (activeTab === 'saved') {
    const userBookmarks = await db.select({
        recipe: recipes
    })
    .from(bookmarks)
    .innerJoin(recipes, eq(bookmarks.recipeId, recipes.id))
    .where(eq(bookmarks.userId, user.id))
    .orderBy(desc(bookmarks.createdAt));
    
    recipesToShow = userBookmarks.map(b => b.recipe);
} else {
    recipesToShow = await db.select()
        .from(recipes)
        .where(eq(recipes.userId, user.id))
        .orderBy(desc(recipes.createdAt));
}
---

<Layout>
    <header class="fixed top-0 w-full z-50 glass">
        <div class="wrapper h-16 flex items-center justify-between">
            <a href="/" class="flex items-center gap-2 group">
                <span class="font-serif text-2xl font-bold tracking-tight">RecipeSwap.</span>
                <span class="text-[10px] font-bold bg-brand-accent text-brand-primary px-1.5 py-0.5 rounded uppercase tracking-tighter">Chef</span>
            </a>
            
            <div class="flex items-center gap-4">
                <div class="hidden md:flex flex-col items-end mr-2">
                    <span class="text-xs font-bold text-brand-text leading-tight">{user.name}</span>
                    <span class="text-[10px] text-gray-400 font-medium">Verified Chef</span>
                </div>
                <button id="logout-btn" class="btn-ghost text-xs py-2 px-4 border border-brand-border rounded-full hover:bg-red-50 hover:text-red-600 hover:border-red-100 transition-all">
                    Sign Out
                </button>
            </div>
        </div>
    </header>

    <main class="pt-24 pb-20 min-h-screen bg-gray-50/30">
        <div class="wrapper">
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-6 mb-12">
                <div class="space-y-2">
                    <h1 class="text-4xl font-bold font-serif">Kitchen Control</h1>
                    <p class="text-gray-500">Manage your published masterpieces and bookmarks.</p>
                </div>
                <a href="/dashboard/create" class="btn-primary flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                    New Recipe
                </a>
            </div>

            <!-- Tabs -->
            <div class="flex gap-4 mb-8 border-b border-gray-200">
                <a 
                    href="/dashboard?tab=my-recipes" 
                    class={`pb-4 px-2 text-sm font-bold transition-all border-b-2 ${activeTab === 'my-recipes' ? 'border-brand-primary text-brand-primary' : 'border-transparent text-gray-400 hover:text-gray-600'}`}
                    transition:name="tab-my-recipes"
                >
                    My Recipes
                </a>
                <a 
                    href="/dashboard?tab=saved" 
                    class={`pb-4 px-2 text-sm font-bold transition-all border-b-2 ${activeTab === 'saved' ? 'border-brand-primary text-brand-primary' : 'border-transparent text-gray-400 hover:text-gray-600'}`}
                    transition:name="tab-saved"
                >
                    Saved Bookmarks
                </a>
            </div>

            <div class="space-y-4">
                {recipesToShow.length === 0 ? (
                    <div class="flex flex-col items-center justify-center py-24 border-2 border-dashed border-gray-200 rounded-3xl bg-white shadow-sm text-center">
                        <div class="w-20 h-20 bg-brand-accent rounded-full flex items-center justify-center mb-6 text-brand-primary">
                             <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/></svg>
                        </div>
                        <h2 class="text-2xl font-bold font-serif mb-2">Nothing here yet</h2>
                        <p class="text-gray-500 mb-8 max-w-sm leading-relaxed">
                            {activeTab === 'saved' ? "You haven't bookmarked any recipes yet." : "You haven't published any recipes yet."}
                        </p>
                    </div>
                ) : (
                    recipesToShow.map((recipe) => (
                        <div class="flex items-center gap-6 p-4 md:p-6 bg-white border border-brand-border rounded-2xl shadow-sm hover:shadow-md transition-shadow group">
                            <div class="w-20 h-20 md:w-24 md:h-24 rounded-xl overflow-hidden bg-gray-100 shrink-0">
                                {recipe.coverImage ? (
                                    <img src={recipe.coverImage} class="w-full h-full object-cover" alt="" />
                                ) : (
                                    <div class="w-full h-full flex items-center justify-center bg-brand-accent/30 text-brand-primary/40">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                                    </div>
                                )}
                            </div>

                            <div class="flex-1 min-w-0">
                                <h3 class="text-xl font-bold font-serif truncate group-hover:text-brand-primary transition-colors">
                                    {recipe.title}
                                </h3>
                                <div class="flex items-center gap-4 mt-2">
                                    <a href={`/recipe/${recipe.slug}`} class="text-xs font-bold text-gray-400 hover:text-brand-text flex items-center gap-1">
                                        View Recipe <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></svg>
                                    </a>
                                </div>
                            </div>

                            {activeTab === 'my-recipes' && (
                                <div class="flex flex-col md:flex-row gap-2 ml-4">
                                    <a href={`/dashboard/edit/${recipe.id}`} class="btn-outline text-xs px-4 py-2 flex items-center gap-2">
                                        Edit
                                    </a>
                                    <button 
                                        data-id={recipe.id}
                                        class="delete-btn btn-ghost text-xs px-4 py-2 flex items-center gap-2 text-red-400 hover:text-red-600"
                                    >
                                        Delete
                                    </button>
                                </div>
                            )}
                        </div>
                    ))
                )}
            </div>
        </div>
    </main>

    <script>
        import { authClient } from "../../lib/auth-client";
        import { actions } from "astro:actions";

        document.getElementById('logout-btn')?.addEventListener('click', async () => {
            await authClient.signOut({
                fetchOptions: {
                    onSuccess: () => { window.location.href = "/login"; }
                }
            });
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                if (!confirm('This action cannot be undone. Delete this recipe permanently?')) return;
                const id = (e.currentTarget as HTMLButtonElement).dataset.id;
                if (!id) return;
                const { error } = await actions.deleteRecipe({ id });
                if (!error) window.location.reload();
                else alert('Operation failed.');
            });
        });
    </script>
</Layout>
